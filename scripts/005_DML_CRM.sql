--USE MASTER
--DROP  DATABASE MINICRM
CREATE DATABASE MINICRM
GO
USE MINICRM
GO
--CRIANDO TABELA DE CARGOS

CREATE TABLE CARGOS
  (ID_CARGO INT NOT NULL PRIMARY KEY,
   NOME_CARGO VARCHAR(50) NOT NULL
   )
--CRIANDO TABELAS DE USUARIOS
--DROP TABLE USUARIOS
CREATE TABLE USUARIOS
	(
	LOGIN VARCHAR(30) NOT NULL,
	MATRICULA INT NOT NULL,
	SENHA   VARCHAR(32) NOT NULL,
	SITUACAO CHAR(1) NOT NULL CHECK  (SITUACAO IN ('A','B')), --A=ATIVO -B BLOQUEADO
	ID_CARGO INT NOT NULL,
	CONSTRAINT PK_US1 PRIMARY KEY (MATRICULA),
	CONSTRAINT FK_US1 FOREIGN KEY (ID_CARGO) REFERENCES CARGOS(ID_CARGO)
	)

--CRIANDA TABELA CLIENTE
--DROP TABLE CLIENTE
  CREATE TABLE CLIENTE
    (ID_CLIENTE INT NOT NULL PRIMARY KEY,
	 NOME_CLIENTE VARCHAR(50) NOT NULL,
	 CNPJ VARCHAR(18) NOT NULL
	 )

--CRIANDO TABELA DE AGENDA

CREATE TABLE AGENDA
 (
  ID_AGENDA INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
  MATRICULA INT NOT NULL,
  ID_CLIENTE INT NOT NULL,
  DATA_VISITA DATE,
  HORA_VISITA_DE TIME,
  HORA_VISITA_ATE TIME,
  SITUACAO CHAR(1) NOT NULL CHECK (SITUACAO IN ('P','R','C')), --P-PLANEJADA R-REALIZADA -C-CANCELADA
  OBS VARCHAR(255),
  DATA_LOG DATETIME NOT NULL  DEFAULT GETDATE(),
  CONSTRAINT FK_AG1 FOREIGN KEY (MATRICULA) REFERENCES USUARIOS(MATRICULA),
  CONSTRAINT FK_AG2 FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTE(ID_CLIENTE)
  )
--CRIACAO DA TABELAS DO FOLLOW UP DA AGENDA
CREATE TABLE FOLLOW_UP_AGENDA
(
  ID_AGENDA INT NOT NULL,
  GEROU_VENDA CHAR(1)NOT NULL CHECK (GEROU_VENDA IN ('S','N')), --S/N
  OBS_POS_VISITA VARCHAR(255) NOT NULL,
  DATA DATETIME NOT NULL DEFAULT GETDATE(),
  CONSTRAINT FK_FUP1 FOREIGN KEY (ID_AGENDA) REFERENCES AGENDA(ID_AGENDA)
)

--CRIANDO INDICE
 CREATE INDEX IX_FUP01 ON FOLLOW_UP_AGENDA(ID_AGENDA);

--CANAL VENDA GERENTE VENDEDOR
CREATE TABLE CANAL_VENDAS_GER_VEND
	(
     MAT_GER INT NOT NULL,
	 MAT_VEND INT NOT NULL,
	 CONSTRAINT FK_CNGV1 FOREIGN KEY (MAT_GER) REFERENCES USUARIOS(MATRICULA),
	 CONSTRAINT FK_CNGV2 FOREIGN KEY (MAT_VEND) REFERENCES USUARIOS(MATRICULA),
	 CONSTRAINT U_CNVG1 UNIQUE (MAT_GER,MAT_VEND))

--CANAL VENDA VENDEDOR CLIENTE
CREATE TABLE CANAL_VENDAS_VEND_CLI
	(
     MAT_VEND INT NOT NULL,
	 ID_CLIENTE INT NOT NULL,
	 CONSTRAINT FK_CNVC1 FOREIGN KEY (MAT_VEND) REFERENCES USUARIOS(MATRICULA),
	 CONSTRAINT FK_CNVC2 FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTE(ID_CLIENTE),
	 CONSTRAINT U_CNVC1 UNIQUE (MAT_VEND,ID_CLIENTE))

--DML
-- CARGA TABELA CARGOS
  INSERT INTO CARGOS VALUES (1,'GERENTE')
  INSERT INTO CARGOS VALUES (2,'VENDEDOR')

--CARGAS TABELAS USUARIO

	INSERT INTO USUARIOS VALUES ('ANDRER',1,'123456','A',1)
	INSERT INTO USUARIOS VALUES('PEDROT',2,'123456','A',1)
	INSERT INTO USUARIOS VALUES('CARLOJ',3,'123456','A',2)
	INSERT INTO USUARIOS VALUES('RICARDOF',4,'123456','A',2)
	INSERT INTO USUARIOS VALUES('MARIAM',5,'123456','A',2)
	INSERT INTO USUARIOS VALUES('CARLAG',6,'123456','A',2)
	
--CARGA CLIENTES
    INSERT INTO CLIENTE VALUES (1,'CLIENTE 1','00.000.999/0001-01')
	INSERT INTO CLIENTE VALUES (2,'CLIENTE 2','00.000.999/0001-02')
	INSERT INTO CLIENTE VALUES (3,'CLIENTE 3','00.000.999/0001-03')
	INSERT INTO CLIENTE VALUES (4,'CLIENTE 4','00.000.999/0001-04')
	INSERT INTO CLIENTE VALUES (5,'CLIENTE 5','00.000.999/0001-05')
	INSERT INTO CLIENTE VALUES (6,'CLIENTE 6','00.000.999/0001-06')

--CARGA CANAL DE VENDAS GERENTE VENDEDOR
INSERT INTO CANAL_VENDAS_GER_VEND VALUES (1,3)
INSERT INTO CANAL_VENDAS_GER_VEND VALUES (1,4)

INSERT INTO CANAL_VENDAS_GER_VEND VALUES (2,5)
INSERT INTO CANAL_VENDAS_GER_VEND VALUES (2,6)

--CARGA CANAL DE VENDAS  VENDEDOR CLIENTE
INSERT INTO CANAL_VENDAS_VEND_CLI VALUES (3,1)
INSERT INTO CANAL_VENDAS_VEND_CLI VALUES (3,2)

INSERT INTO CANAL_VENDAS_VEND_CLI VALUES (4,3)
INSERT INTO CANAL_VENDAS_VEND_CLI VALUES (4,4)

INSERT INTO CANAL_VENDAS_VEND_CLI VALUES (5,6)
INSERT INTO CANAL_VENDAS_VEND_CLI VALUES (6,4)

--CARGA DE AGENDAS
--SELECT * FROM AGENDA

INSERT INTO AGENDA VALUES
    (3,1,'2019-01-15','09:00:00','10:00:00','P','TESTE 1',GETDATE()),
    (3,1,'2019-02-15','09:00:00','10:00:00','P','TESTE 2',GETDATE()),
	(3,1,'2019-03-15','09:00:00','10:00:00','P','TESTE 3',GETDATE()),
	(3,1,'2019-04-15','09:00:00','10:00:00','P','TESTE 4',GETDATE()),
	(3,1,'2019-05-15','09:00:00','10:00:00','P','TESTE 5',GETDATE()),
	(3,1,'2019-06-15','09:00:00','10:00:00','P','TESTE 6',GETDATE()),
	(3,1,'2019-07-15','09:00:00','10:00:00','P','TESTE 7',GETDATE()),
	(3,1,'2019-08-15','09:00:00','10:00:00','P','TESTE 8',GETDATE()),
    (3,1,'2019-09-15','09:00:00','10:00:00','P','TESTE 9',GETDATE()),
	(3,1,'2019-10-15','09:00:00','10:00:00','P','TESTE 10',GETDATE()),
	(3,1,'2019-11-15','09:00:00','10:00:00','P','TESTE 11',GETDATE()),
	(3,1,'2019-12-15','09:00:00','10:00:00','P','TESTE 12',GETDATE())
   
INSERT INTO AGENDA VALUES
    (4,2,'2019-01-15','09:00:00','10:00:00','P','TESTE 1',GETDATE()),
    (4,2,'2019-02-15','09:00:00','10:00:00','P','TESTE 2',GETDATE()),
	(4,2,'2019-03-15','09:00:00','10:00:00','P','TESTE 3',GETDATE()),
	(4,2,'2019-04-15','09:00:00','10:00:00','P','TESTE 4',GETDATE()),
	(4,2,'2019-05-15','09:00:00','10:00:00','P','TESTE 5',GETDATE()),
	(4,2,'2019-06-15','09:00:00','10:00:00','P','TESTE 6',GETDATE()),
	(4,2,'2019-07-15','09:00:00','10:00:00','P','TESTE 7',GETDATE()),
	(4,2,'2019-08-15','09:00:00','10:00:00','P','TESTE 8',GETDATE()),
    (4,2,'2019-09-15','09:00:00','10:00:00','P','TESTE 9',GETDATE()),
	(4,2,'2019-10-15','09:00:00','10:00:00','P','TESTE 10',GETDATE()),
	(4,2,'2019-11-15','09:00:00','10:00:00','P','TESTE 11',GETDATE()),
	(4,2,'2019-12-15','09:00:00','10:00:00','P','TESTE 12',GETDATE())

INSERT INTO AGENDA VALUES
    (5,3,'2019-01-15','09:00:00','10:00:00','P','TESTE 1',GETDATE()),
    (5,3,'2019-02-15','09:00:00','10:00:00','P','TESTE 2',GETDATE()),
	(5,3,'2019-03-15','09:00:00','10:00:00','P','TESTE 3',GETDATE()),
	(5,3,'2019-04-15','09:00:00','10:00:00','P','TESTE 4',GETDATE()),
	(5,3,'2019-05-15','09:00:00','10:00:00','P','TESTE 5',GETDATE()),
	(5,3,'2019-06-15','09:00:00','10:00:00','P','TESTE 6',GETDATE()),
	(5,3,'2019-07-15','09:00:00','10:00:00','P','TESTE 7',GETDATE()),
	(5,3,'2019-08-15','09:00:00','10:00:00','P','TESTE 8',GETDATE()),
    (5,3,'2019-09-15','09:00:00','10:00:00','P','TESTE 9',GETDATE()),
	(5,3,'2019-10-15','09:00:00','10:00:00','P','TESTE 10',GETDATE()),
	(5,3,'2019-11-15','09:00:00','10:00:00','P','TESTE 11',GETDATE()),
	(5,3,'2019-12-15','09:00:00','10:00:00','P','TESTE 12',GETDATE())

INSERT INTO AGENDA VALUES
    (6,4,'2019-01-15','09:00:00','10:00:00','P','TESTE 1',GETDATE()),
    (6,4,'2019-02-15','09:00:00','10:00:00','P','TESTE 2',GETDATE()),
	(6,4,'2019-03-15','09:00:00','10:00:00','P','TESTE 3',GETDATE()),
	(6,4,'2019-04-15','09:00:00','10:00:00','P','TESTE 4',GETDATE()),
	(6,4,'2019-05-15','09:00:00','10:00:00','P','TESTE 5',GETDATE()),
	(6,4,'2019-06-15','09:00:00','10:00:00','P','TESTE 6',GETDATE()),
	(6,4,'2019-07-15','09:00:00','10:00:00','P','TESTE 7',GETDATE()),
	(6,4,'2019-08-15','09:00:00','10:00:00','P','TESTE 8',GETDATE()),
    (6,4,'2019-09-15','09:00:00','10:00:00','P','TESTE 9',GETDATE()),
	(6,4,'2019-10-15','09:00:00','10:00:00','P','TESTE 10',GETDATE()),
	(6,4,'2019-11-15','09:00:00','10:00:00','P','TESTE 11',GETDATE()),
	(6,4,'2019-12-15','09:00:00','10:00:00','P','TESTE 12',GETDATE())

--SELECT * FROM FOLLOW_UP_AGENDA
--CARGA DE FOLLOW_UP DE AGENDA
INSERT INTO FOLLOW_UP_AGENDA
SELECT ID_AGENDA,
CASE WHEN ID_AGENDA%2<>0 THEN 'S' ELSE 'N' END GERA_VENDA,
'TESTE DE OBS...' OBS,
GETDATE()
FROM  AGENDA

GO





